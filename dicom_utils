import os, sys
from pathlib import Path
from tempfile import TemporaryDirectory
import warnings

from pydicom import dcmread
from pydicom.data import get_testdata_file
from pydicom.fileset import FileSet
from pydicom.uid import generate_uid

import datetime
#import dateutil.relativedelta
from dateutil.relativedelta import *



global folder_path
global second_folder_path

second_folder_path = "C:/Users/Jonathan/Documents/Projects/Caristo_Test/DICOM_utility/raw_data/different_birthdate_dicom_files/"
folder_path = "C:/Users/Jonathan/Documents/Projects/Caristo_Test/DICOM_utility/raw_data/cube_dicom_files/"

def get_datetime_obj():
    # Set current date/time
    dt = datetime.datetime.now()
    
    current_date= dt.strftime('%Y%m%d')
    current_time = dt.strftime('%H%M%S')
    print(current_date)
    print(current_time)
    return dt, current_date, current_time



def file_generator(folder_path):
    """

    Parameters
    ----------
    folder_path : string
        this opens each file in a directory to be editted.
        on next, file is written

    Returns
    -------
    None.

    """
    
    for file_name in os.listdir(folder_path):
        if file_name.endswith(".dcm"): 
            file_path=os.path.join(folder_path,file_name)
            patient = dcmread(file_path)
            yield patient
            
            patient.save_as(file_path)
    
    
def set_current_dt_for_files_in_folder(folder_path,print_patient):
    
    dt, current_date, current_time=get_datetime_obj()
    for patient in file_generator(folder_path):
        patient_data_output_control(patient,print_patient)
        #print(patient.ContentDate)
        #print(patient.ContentTime)
        patient.ContentDate=current_date
        patient.ContentTime=current_time
    #print(patient.ContentDate)
    #print(patient.ContentTime)
    
    
    # print(os.path.join(directory, filename))
        
def set_patient_age_for_files_in_folder(folder_path,print_patient):
    
    for patient in file_generator(folder_path):
        patient_data_output_control(patient,print_patient)
        set_patient_age(patient)
    
def set_patient_age(patient):
    print("In patient age")
    birth_date=patient.PatientBirthDate
    study_date=patient.StudyDate
    print("bd: " + birth_date)
    print("sd: "+study_date)
    patient_age=str(get_patient_age(birth_date,study_date))
    print("original patient age: " + patient_age)
    patient.Age=patient_age
    print("new patient age: " + patient_age)
    
def get_patient_age(birth_date,study_date):
    birth_date=datetime.datetime(int(birth_date[:4]), int(birth_date[4:6]), int(birth_date[6:]))
    study_date=datetime.datetime(int(study_date[:4]), int(study_date[4:6]), int(study_date[6:]))
    
    time_difference = relativedelta(study_date,birth_date)
    return time_difference.years
    

def patient_data_output_control(patient,print_patient):    
    if print_patient:
        print(patient)

def print_patient_data(file_path,print_patient):
    patient = dcmread(file_path)
    patient_data_output_control(patient, print_patient)
    
def modify_patient_data(file_path, name="", sex="", birth_date=""):
    patient = dcmread(file_path)
    if name:
        patient.PatientName=name
    if sex:
        patient.PatientSex=sex
    if  birth_date:
        patient.PatientBirthDate=birth_date
    patient.save_as(file_path)
    

    



    

if __name__=="__main__":
    file1= r"""C:\Users\Jonathan\Documents\Projects\Caristo_Test\DICOM_utility\raw_data\different_birthdate_dicom_files\image10_28021985.dcm"""
    file2= r"""C:\Users\Jonathan\Documents\Projects\Caristo_Test\DICOM_utility\raw_data\different_birthdate_dicom_files\image11_29021984.dcm"""
    
    print_patient_data(file1,True)
    print_patient_data(file2,True)
    modify_patient_data(file1,name="Timmy",sex="1",birth_date="20001212")
    
    set_current_dt_for_files_in_folder(folder_path,True)
    set_patient_age_for_files_in_folder(second_folder_path,True)
    #print(os.path.dirname(sys.path[0]))